name: Prose Check

on:
  pull_request:
    paths:
      - '**.md'
      - '**.txt'
      - 'docs/**'
  push:
    branches: [main, master]
    paths:
      - '**.md'
      - '**.txt'
      - 'docs/**'
  workflow_dispatch:

jobs:
  check:
    name: Check prose for AI patterns
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **.md
            **.txt
            docs/**

      - name: Run prose check
        if: steps.changed-files.outputs.any_changed == 'true'
        id: prose-check
        continue-on-error: true
        run: |
          echo "Checking files: ${{ steps.changed-files.outputs.all_changed_files }}"
          python check_writing.py --format json ${{ steps.changed-files.outputs.all_changed_files }} > prose-report.json 2>&1 || true
          cat prose-report.json

      - name: Upload report artifact
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: prose-report
          path: prose-report.json

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let report;
            try {
              const content = fs.readFileSync('prose-report.json', 'utf8');
              report = JSON.parse(content);
            } catch (e) {
              console.log('Could not parse report:', e);
              return;
            }

            // Handle both single file and batch reports
            const files = report.files || [report];
            const summary = report.summary || {
              total_files: 1,
              passing: report.score >= 60 ? 1 : 0,
              failing: report.score < 60 ? 1 : 0,
              average_score: report.score
            };

            let body = '## Prose Check Report\n\n';
            body += `**Files checked:** ${summary.total_files}\n`;
            body += `**Passing:** ${summary.passing} | **Failing:** ${summary.failing}\n`;
            body += `**Average score:** ${summary.average_score.toFixed(1)}/100\n\n`;

            // Show details for failing files
            const failing = files.filter(f => f.score < 60);
            if (failing.length > 0) {
              body += '### Files needing attention\n\n';
              for (const file of failing.slice(0, 5)) {
                body += `#### ${file.filename} (Score: ${file.score})\n`;
                if (file.high_severity && file.high_severity.length > 0) {
                  body += '**High severity findings:**\n';
                  for (const f of file.high_severity.slice(0, 3)) {
                    const alt = f.alternative ? ` â†’ ${f.alternative}` : '';
                    body += `- \`${f.pattern}\`${alt} (${f.count}x)\n`;
                  }
                }
                body += '\n';
              }
            }

            body += '\n---\n*Generated by [Prose Check](https://github.com/your-org/prose-check)*';

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Prose Check Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Check results
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          if [ -f prose-report.json ]; then
            # Check if any files failed
            FAILING=$(python3 -c "
          import json
          with open('prose-report.json') as f:
              data = json.load(f)
          if 'summary' in data:
              print(data['summary']['failing'])
          else:
              print(0 if data.get('score', 100) >= 60 else 1)
          ")
            if [ "$FAILING" -gt 0 ]; then
              echo "::error::$FAILING file(s) failed prose check"
              exit 1
            fi
          fi
